name: sonarqube verification

on:
  push:
  workflow_dispatch:

jobs:
  deploy:
    permissions:
      actions: read
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    container:
        image: mcr.microsoft.com/azure-cli:latest
    steps:
      # Checks out the repository this file is in
      - uses: actions/checkout@v4

      # Logs in with your Azure credentials
      - name: Azure login
        uses: Azure/login@v2.0.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: conexion au cluster
        run: az aks get-credentials --resource-group monResourceGroup --name monClusterAKS

      - uses: Azure/setup-kubectl@v4.0.0      
        id: install

      - name : port-forward
        run: kubectl port-forward svc/sonarqube-sonarqube -n sonarqube --address 0.0.0.0 9000 &

      - name: Wait for SonarQube to be ready
        run: sleep 5

      - name: curl sonarqube
        run: |
          apk add curl

      - name: curl sonarqube
        run: |
          curl http://localhost:9000

      - name : kubectl get svc -n sonarqube
        run: kubectl get svc -n sonarqube

      - name: Official SonarQube Scan test
        uses: SonarSource/sonarqube-scan-action@v2.0.1
        env:
          #SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_IP }}
#          sonar.login: admin
#          sonar.password: admin
