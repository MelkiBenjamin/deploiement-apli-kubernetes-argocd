name: configuration et deploie aplication sur aks
on: [workflow_dispatch, push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: installer Add Docker's official GPG key
      run: |
        sudo apt-get update
        sudo apt-get install ca-certificates curl
        sudo install -m 0755 -d /etc/apt/keyrings
        sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        sudo chmod a+r /etc/apt/keyrings/docker.asc
        echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
        $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
        sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt-get update

    - name: installer Docker
      run: sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

#    - name: installer docker
#      uses: crazy-max/ghaction-setup-docker@v3

    - name: installer kubectl
      run: sudo apt-get update && sudo apt-get install -y kubectl

#    - name: installer kubectl
#      uses: azure/setup-kubectl@v3
#      with:
#        version: v1.28.2 # default is latest stable
#      id: install

    - name: installer minikube
      run:  |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube

    - name: demarer minikube
      run: minikube start --driver=docker

    - name: creer namespace argocd
      run: kubectl create namespace argocd

    - name: installe argocd
      run: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/ha/install.yaml

    - name: sleep 30s
      run: sleep 30s

    - name: redirection pôrt argocd
      run: kubectl port-forward svc/argocd-server -n argocd 8080:443 &

    - name: install cli argocd
      run: |
        curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
        rm argocd-linux-amd64

#    - name: sleep 30s 
#      run: sleep 30s

    - name: Exécuter la commande argocd 
      run: | 
        argocd admin initial-password -n argocd > password_file.txt
    
    - name: Se connecter à Argo CD
      run: |
        password=$(cat password_file.txt)
        echo "$password" | argocd login localhost:8080 --insecure --username admin 
#    - name: argocd new mdp
#      run: argocd account update-password --current-password Z9Zx9cqZw3BfSQ4N --new-password admin
      
    - name: creer application et synchronize automatique a github
      run: argocd app create evershop --repo https://github.com/MelkiBenjamin/test-deploiement-apli-kubenete-argocd --path evershop --dest-server https://kubernetes.default.svc --dest-namespace default --sync-policy automated --auto-prune
      
    - name: affiche l'url du service
      run: minikube service evershop --url      
    